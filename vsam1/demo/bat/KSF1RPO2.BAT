@echo off
REM LOAD KSDS KSF1NAME CLUSTER AND ALTERNATE INDEXES, UNLOAD, AND VERIFY
rem %0 in z390\vsam1\demo\bat; switch to z390
pushd %~dps0..\..\..

SET PGMNAME=KSF1RPO2
SET VSAMPATH=vsam1\demo
SET ZVSAM=ZVSAM(1)
SET TRACE=%
IF /I "%1" == "traceall" (
    SET TRACE=TRACEALL
    shift /1
)

SET RC=0

REM load KSDS KSF1NAME
SET INFILE=%VSAMPATH%\KSF1NAME.TF1[RECFM=FT]
SET OUTFILE=%VSAMPATH%\DEMOCAT.KSF1NAME
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN LOAD KSF1NAME
	GOTO errmsg
)
REM build AIX KSF1ADDR
SET INFILE=%VSAMPATH%\DEMOCAT.KSF1NAME
SET OUTFILE=%VSAMPATH%\DEMOCAT.KSF1ADDR
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN BUILDAIX KSF1ADDR
	GOTO errmsg
)
REM build AIX KSF1CITY
SET INFILE=%VSAMPATH%\DEMOCAT.KSF1NAME
SET OUTFILE=%VSAMPATH%\DEMOCAT.KSF1CITY
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN BUILDAIX KSF1CITY
	GOTO errmsg
)
REM build AIX KSF1STAT
SET INFILE=%VSAMPATH%\DEMOCAT.KSF1NAME
SET OUTFILE=%VSAMPATH%\DEMOCAT.KSF1STAT
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN BUILDAIX KSF1STAT
	GOTO errmsg
)
REM build AIX KSF1ZIP
SET INFILE=%VSAMPATH%\DEMOCAT.KSF1NAME
SET OUTFILE=%VSAMPATH%\DEMOCAT.KSF1ZIP 
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN BUILDAIX KSF1ZIP
	GOTO errmsg
)
REM unload KSDS KSF1NAME
SET INFILE=%VSAMPATH%\DEMOCAT.KSF1NAME
SET OUTFILE=%VSAMPATH%\KSF1NAME.TF2[RECFM=FT]
IF EXIST %VSAMPATH%\KSF1NAME.TF2 ERASE %VSAMPATH%\KSF1NAME.TF2
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN UNLOAD KSF1NAME
	GOTO errmsg
)
REM compare input and output QSAM files
fc %VSAMPATH%\KSF1NAME.TF1 %VSAMPATH%\KSF1NAME.TF2 > %VSAMPATH%\%PGMNAME%.DIF 
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN COMPARING KSF1NAME
	GOTO errmsg
)

GOTO skipnl

REM the unload of NAMELIST fails due to REPRO ABEND S013; sample console
REM 10:34:04 REPRO     EZ390 START USING z390 v1.8.1 ON J2SE 17.0.6 02/22/23
REM REPRO z390 VSAM UTILITY V1.2
REM REPRO UNLOADING VSAM INFILE TO QSAM OUTFILE
REM EZ390E error  43 I/O error for DCB=000FE050 DDNAME=VXN#2 FILE=
REM EZ390E error  23 i/o error on open - java.io.FileNotFoundException:
REM ...
REM EZ390E error  12 program aborting due to abend S013
REM 10:34:04 REPRO     EZ390 ENDED   RC=16 SEC= 0 MEM(MB)= 19 IO=203 INS=122


REM unload NAMELIST
SET INFILE=%VSAMPATH%\DEMOCAT.NAMELIST
SET OUTFILE=%VSAMPATH%\KSF1NAME.TF2[RECFM=FT]
IF EXIST %VSAMPATH%\KSF1NAME.TF2 ERASE %VSAMPATH%\KSF1NAME.TF2
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN UNLOAD NAMELIST
	GOTO errmsg
)
REM compare input and output QSAM files
fc %VSAMPATH%\KSF1NAME.TF1 %VSAMPATH%\KSF1NAME.TF2 > %VSAMPATH%\%PGMNAME%.DIF
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN COMPARING NAMELIST
	GOTO errmsg
)

:skipnl

REM unload ADDRLIST
SET INFILE=%VSAMPATH%\DEMOCAT.ADDRLIST
SET OUTFILE=%VSAMPATH%\KSF1ADDR.TF2[RECFM=FT]
IF EXIST %VSAMPATH%\KSF1ADDR.TF2 ERASE %VSAMPATH%\KSF1ADDR.TF2
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN UNLOAD ADDRLIST
	GOTO errmsg
)
REM compare input and output QSAM files
fc %VSAMPATH%\KSF1ADDR.TF1 %VSAMPATH%\KSF1ADDR.TF2 > %VSAMPATH%\%PGMNAME%.DIF
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN COMPARING ADDRLIST
	GOTO errmsg
)
REM unload CITYLIST
SET INFILE=%VSAMPATH%\DEMOCAT.CITYLIST
SET OUTFILE=%VSAMPATH%\KSF1CITY.TF2[RECFM=FT]
IF EXIST %VSAMPATH%\KSF1CITY.TF2 ERASE %VSAMPATH%\KSF1CITY.TF2
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN UNLOAD CITYLIST
	GOTO errmsg
)
REM compare input and output QSAM files
fc %VSAMPATH%\KSF1CITY.TF1 %VSAMPATH%\KSF1CITY.TF2 > %VSAMPATH%\%PGMNAME%.DIF
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN COMPARING CITYLIST
	GOTO errmsg
)
REM unload STATLIST
SET INFILE=%VSAMPATH%\DEMOCAT.STATLIST
SET OUTFILE=%VSAMPATH%\KSF1STAT.TF2[RECFM=FT]
IF EXIST %VSAMPATH%\KSF1STAT.TF2 ERASE %VSAMPATH%\KSF1STAT.TF2
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN UNLOAD STATLIST
	GOTO errmsg
)
REM compare input and output QSAM files
fc %VSAMPATH%\KSF1STAT.TF1 %VSAMPATH%\KSF1STAT.TF2 > %VSAMPATH%\%PGMNAME%.DIF 
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN COMPARING STATLIST
	GOTO errmsg
)
REM unload ZIPLIST
SET INFILE=%VSAMPATH%\DEMOCAT.ZIPLIST
SET OUTFILE=%VSAMPATH%\KSF1ZIP.TF2[RECFM=FT]
IF EXIST %VSAMPATH%\KSF1ZIP.TF2 ERASE %VSAMPATH%\KSF1ZIP.TF2
CALL bat\EXEC linklib\REPRO %1 %2 %3 %4 %5 %ZVSAM% %TRACE%
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN UNLOAD ZIPLIST
	GOTO errmsg
)
REM compare input and output QSAM files
fc %VSAMPATH%\KSF1ZIP.TF1 %VSAMPATH%\KSF1ZIP.TF2 > %VSAMPATH%\%PGMNAME%.DIF
SET RC=%ERRORLEVEL%
IF %RC% NEQ 0 (
    SET ERRMSG=ERROR IN COMPARING ZIPLIST
	GOTO errmsg
)

:return
popd
exit /b %RC%
:errmsg
echo ERROR: %ERRMSG%
SET RC=8
GOTO return
